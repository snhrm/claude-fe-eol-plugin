---
description: フロントエンドライブラリのEOL対応計画を作成し、MDファイルに出力する
argument-hint: [ライブラリ名@バージョン] (省略可。省略時は全体を対象)
allowed-tools: Read, Write, Edit, Grep, Glob, Bash, WebFetch, WebSearch, Task
---

# EOL対応計画の作成

フロントエンドプロジェクトのライブラリEOL（End of Life）対応計画を作成し、Markdownファイルに出力します。

## 引数

- `$ARGUMENTS`: ライブラリ名とバージョンを指定（例: `react@19`, `next@15`）
  - 複数指定可能（スペース区切り）
  - 省略時: プロジェクト全体の依存関係を対象に計画を作成

## 実行手順

### Step 1: 出力先の決定

1. まず `CLAUDE.md` を読み込み、EOL計画の出力先が指定されているか確認する
   - 指定がある場合: 指定されたパスに出力
   - 指定がない場合: プロジェクトルートに `eol-plan.md` を作成

出力先の指定例（CLAUDE.md内）:
```
EOL計画出力先: docs/eol-plan.md
```

### Step 2: パッケージマネージャーの特定

プロジェクト内のファイルを確認し、使用しているパッケージマネージャーを特定:

| ファイル | パッケージマネージャー |
|---------|---------------------|
| `package-lock.json` | npm |
| `yarn.lock` | yarn |
| `pnpm-lock.yaml` | pnpm |
| `bun.lockb` または `bun.lock` | bun |

複数存在する場合の優先順位: bun > pnpm > yarn > npm

### Step 3: アップデート可能なパッケージの確認

#### npm-check-updates を使用

```bash
# グローバルにインストールされていない場合は npx を使用
npx npm-check-updates

# 特定のパッケージのみ確認
npx npm-check-updates -f "react,next"

# メジャーアップデートのみ表示
npx npm-check-updates --target major

# マイナーアップデートのみ表示
npx npm-check-updates --target minor

# パッチアップデートのみ表示
npx npm-check-updates --target patch
```

#### パッケージマネージャー別のauditコマンド

```bash
# npm
npm audit
npm outdated

# yarn
yarn audit
yarn outdated

# pnpm
pnpm audit
pnpm outdated

# bun
bun pm cache  # キャッシュ確認
# bunは現時点でaudit未サポート、npm auditを代用
```

### Step 4: 対象ライブラリの特定

引数がある場合（`$ARGUMENTS` が指定されている場合）:
- 指定されたライブラリのみを対象とする
- 例: `react@19 next@15` → React 19 と Next.js 15 への更新を計画

引数がない場合:
- `npm-check-updates` と `audit` の結果から対象を決定
- 以下の優先順位で対象を決定:
  1. セキュリティ脆弱性があるパッケージ（audit結果）
  2. EOLまたはサポート終了のパッケージ
  3. メジャーバージョンアップが可能なパッケージ
  4. マイナー/パッチアップデートがあるパッケージ

### Step 5: 各ライブラリの影響調査

`library-update-analyzer` サブエージェントを使用して、各ライブラリについて調査。

サブエージェントへの入力形式:
```
ライブラリ: {ライブラリ名}
現在のバージョン: {現在のバージョン}
アップグレード先バージョン: {目標バージョン}
```

調査内容:
1. 破壊的変更と影響範囲
2. 依存関係の連鎖アップデート要件
3. 既存コードへの影響箇所
4. テストカバレッジと追加テスト要件

### Step 6: アップグレード戦略の決定

調査結果に基づき、最適なアップグレード戦略を決定:

#### 一括アップグレード（推奨条件）
- 破壊的変更が少ない
- 依存関係の競合がない
- 影響範囲が限定的

#### 段階的アップグレード（推奨条件）
以下の場合は段階的なアップグレードを計画:

1. **パッチバージョンのみ先行**
   - セキュリティ修正を優先適用
   - 動作確認後にマイナー/メジャーへ

2. **マイナーバージョンまで先行**
   - 新機能は使わず互換性維持
   - 十分なテスト後にメジャーへ

3. **ライブラリ単位で段階化**
   - 依存関係の少ないものから順に
   - 例: ユーティリティ → UI → フレームワーク

4. **機能単位で段階化**
   - 影響の少ない機能から移行
   - 例: 内部API → 外部API → 認証

### Step 7: 計画書の作成

以下のフォーマットでMDファイルを出力:

```markdown
# EOL対応計画

作成日: {日付}
対象プロジェクト: {プロジェクト名}
パッケージマネージャー: {npm/yarn/pnpm/bun}

## 概要

| 項目 | 内容 |
|------|------|
| 対象ライブラリ数 | X件 |
| セキュリティ脆弱性 | X件 |
| 推定作業期間 | {見積もり} |
| リスクレベル | {低/中/高} |
| 推奨戦略 | {一括/段階的} |

## セキュリティ監査結果

{パッケージマネージャー} audit 結果:

| パッケージ | 脆弱性レベル | 説明 | 修正バージョン |
|-----------|------------|------|--------------|
| {pkg1} | 🔴 critical | {説明} | x.x.x |
| {pkg2} | 🟠 high | {説明} | x.x.x |

## アップデート可能なパッケージ

npm-check-updates 結果:

| パッケージ | 現在 | 最新 | 変更種別 | 優先度 |
|-----------|------|------|---------|--------|
| react | 18.2.0 | 19.0.0 | major | 中 |
| next | 14.0.0 | 15.0.0 | major | 中 |
| typescript | 5.0.0 | 5.3.0 | minor | 低 |

## 現在の依存関係

| ライブラリ | 現在バージョン | 最新バージョン | EOL状況 | 優先度 |
|-----------|--------------|--------------|---------|--------|
| react | 18.2.0 | 19.x.x | サポート中 | 中 |
| next | 14.x.x | 15.x.x | サポート中 | 中 |
| node | 18.x.x | 22.x.x | LTS | 高 |

## アップグレード戦略

### 推奨アプローチ: {一括/段階的}

{選択理由の説明}

## 段階的アップグレード計画

### Phase 1: {フェーズ名}
**目標**: {目標の説明}
**対象**:
- {ライブラリ1}: {現在} → {目標}
- {ライブラリ2}: {現在} → {目標}

**作業内容**:
1. [ ] {作業1}
2. [ ] {作業2}

**確認項目**:
- [ ] ビルド成功
- [ ] テスト通過
- [ ] 動作確認

**破壊的変更への対応**:
| 変更内容 | 影響ファイル | 対応方法 |
|---------|------------|---------|
| {変更1} | src/xxx.tsx | {対応} |

**アップデートコマンド**:
```bash
# {パッケージマネージャー}の場合
{アップデートコマンド}
```

---

### Phase 2: {フェーズ名}
...

## ライブラリ別詳細

### {ライブラリ名}

#### 変更点サマリー
- 🔴 破壊的変更: X件
- 🟠 非推奨化: Y件
- 🟡 新機能: Z件

#### 破壊的変更一覧
1. **{変更タイトル}**
   - 影響: {影響の説明}
   - 対応: {対応方法}
   - 該当ファイル: {ファイルリスト}

#### テスト要件
- [ ] {必要なテスト1}
- [ ] {必要なテスト2}

## リスクと対策

| リスク | 発生確率 | 影響度 | 対策 |
|-------|---------|-------|------|
| {リスク1} | 中 | 高 | {対策} |

## ロールバック計画

各フェーズでの問題発生時:
1. {ロールバック手順}

## 参考リンク

- [{ライブラリ} マイグレーションガイド]({URL})
- [{ライブラリ} リリースノート]({URL})
```

## 注意事項

- 必ず `npm-check-updates` と `audit` コマンドを実行して最新情報を取得すること
- 調査は `library-update-analyzer` サブエージェントに委譲し、詳細情報を収集すること
- 依存関係の競合がある場合は、解決順序を明確にすること
- セキュリティアップデートは最優先で計画に含めること
- 各フェーズは独立してテスト・デプロイ可能な単位にすること
- ロールバック可能な計画を常に含めること
- パッケージマネージャーに応じた適切なコマンドを使用すること
